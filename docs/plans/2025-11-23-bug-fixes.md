# Bug Fixes Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Fix critical and high severity bugs identified in the bug hunt to improve geometry validity, 3D printing compliance, and system reliability.

**Architecture:** TDD approach - write failing test first, then fix. Each task is independent and can be done in any order.

**Tech Stack:** TypeScript, Vitest, Manifold-3d

---

## Task 1: Fix Wall Thickness Minimum in Spacer Builder

**Files:**
- Modify: `src/generators/manifold/spacerBuilder.ts:24-26`
- Test: `src/generators/manifold/spacerBuilder.test.ts`

**Context:** AGENTS.md requires 1.2mm minimum wall thickness. Current code uses `outer - 2` which allows 1mm walls on each side. Should use `outer - 2.4` for 1.2mm walls on each side.

**Step 1: Write the failing test**

Add this test to `spacerBuilder.test.ts`:

```typescript
it('enforces 1.2mm minimum wall thickness per AGENTS.md', () => {
  const params = {
    outer_diameter: 10,
    inner_hole: 8, // Would leave 1mm wall, should clamp to 7.6mm (10 - 2.4)
    height: 5
  }

  const spacer = buildSpacer(M, params)
  expectValid(spacer)

  // Calculate expected wall thickness: (10 - 7.6) / 2 = 1.2mm
  // Volume of ring: π * h * (R² - r²)
  // With outer=10, inner clamped to 7.6, height=5:
  // V = π * 5 * (25 - 14.44) = π * 5 * 10.56 ≈ 165.9
  const volume = spacer.volume()
  // If inner was NOT clamped (8mm), volume would be: π * 5 * (25 - 16) = 141.4
  expect(volume).toBeGreaterThan(150) // Proves wall is thicker than 1mm
  spacer.delete()
})
```

**Step 2: Run test to verify it fails**

Run: `npm test -- --run src/generators/manifold/spacerBuilder.test.ts`
Expected: FAIL - volume will be ~141 (below 150) because wall is only 1mm

**Step 3: Fix the wall thickness calculation**

In `src/generators/manifold/spacerBuilder.ts`, change line 25 from:

```typescript
const maxInnerHole = p.outer_diameter - 2
```

To:

```typescript
// AGENTS.md: Minimum wall thickness 1.2mm (2.4mm total for both walls)
const maxInnerHole = p.outer_diameter - 2.4
```

**Step 4: Run test to verify it passes**

Run: `npm test -- --run src/generators/manifold/spacerBuilder.test.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add src/generators/manifold/spacerBuilder.ts src/generators/manifold/spacerBuilder.test.ts
git commit -m "fix(spacer): enforce 1.2mm minimum wall thickness per AGENTS.md"
```

---

## Task 2: Fix Wall Thickness Minimum in Washer Builder

**Files:**
- Modify: `src/generators/manifold/washerBuilder.ts:25`
- Test: `src/generators/manifold/washerBuilder.test.ts`

**Context:** Same issue as spacer - uses `outer - 2` instead of `outer - 2.4`.

**Step 1: Write the failing test**

Add this test to `washerBuilder.test.ts`:

```typescript
it('enforces 1.2mm minimum wall thickness per AGENTS.md', () => {
  const params = {
    outer_diameter: 10,
    inner_diameter: 8, // Would leave 1mm wall, should clamp to 7.6mm
    thickness: 2
  }

  const washer = buildWasher(M, params)
  expectValid(washer)

  // Volume check similar to spacer
  const volume = washer.volume()
  // With 1.2mm walls (inner clamped to 7.6): π * 2 * (25 - 14.44) ≈ 66.4
  // With 1mm walls (inner = 8): π * 2 * (25 - 16) ≈ 56.5
  expect(volume).toBeGreaterThan(60)
  washer.delete()
})
```

**Step 2: Run test to verify it fails**

Run: `npm test -- --run src/generators/manifold/washerBuilder.test.ts`
Expected: FAIL

**Step 3: Fix the wall thickness calculation**

In `src/generators/manifold/washerBuilder.ts`, change line 25 from:

```typescript
const maxInner = p.outer_diameter - 2
```

To:

```typescript
// AGENTS.md: Minimum wall thickness 1.2mm (2.4mm total for both walls)
const maxInner = p.outer_diameter - 2.4
```

**Step 4: Run test to verify it passes**

Run: `npm test -- --run src/generators/manifold/washerBuilder.test.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add src/generators/manifold/washerBuilder.ts src/generators/manifold/washerBuilder.test.ts
git commit -m "fix(washer): enforce 1.2mm minimum wall thickness per AGENTS.md"
```

---

## Task 3: Fix Bracket Rib Thickness Minimum

**Files:**
- Modify: `src/generators/bracket.ts:73`
- Test: `src/generators/types.test.ts` (or create new test)

**Context:** AGENTS.md requires 1.2mm minimum for structural parts. Rib thickness min is currently 1mm.

**Step 1: Write the failing test**

Add this test to `src/generators/types.test.ts` (in the bracket section):

```typescript
it('bracket rib_thickness has 1.2mm minimum per AGENTS.md', () => {
  const ribParam = bracketGenerator.parameters.find(
    p => p.type === 'boolean' && p.name === 'add_rib'
  )
  expect(ribParam).toBeDefined()

  const ribThicknessParam = ribParam?.children?.find(
    (c: { name: string }) => c.name === 'rib_thickness'
  )
  expect(ribThicknessParam).toBeDefined()
  expect(ribThicknessParam?.min).toBeGreaterThanOrEqual(1.2)
})
```

**Step 2: Run test to verify it fails**

Run: `npm test -- --run src/generators/types.test.ts`
Expected: FAIL - min is 1, not >= 1.2

**Step 3: Fix the minimum value**

In `src/generators/bracket.ts`, change line 73 from:

```typescript
min: 1, max: 10, default: 4, step: 0.5, unit: 'mm'
```

To:

```typescript
min: 1.2, max: 10, default: 4, step: 0.5, unit: 'mm'
```

**Step 4: Run test to verify it passes**

Run: `npm test -- --run src/generators/types.test.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add src/generators/bracket.ts src/generators/types.test.ts
git commit -m "fix(bracket): set rib_thickness min to 1.2mm per AGENTS.md"
```

---

## Task 4: Fix Worker Init Failure Communication

**Files:**
- Modify: `src/workers/manifold.worker.ts:68-70`

**Context:** When WASM fails to load, error is only logged to console. Main thread hangs waiting for 'ready' message that never comes.

**Step 1: Understand the fix**

The worker should post an error message to the main thread so `useManifold` can handle it. Add a new message type for init failure.

**Step 2: Add error message type and send it**

In `src/workers/manifold.worker.ts`, first add the interface near line 37:

```typescript
interface InitErrorMessage {
  type: 'init-error'
  error: string
}
```

Then change lines 68-70 from:

```typescript
.catch((err) => {
  console.error('[ManifoldWorker] Failed to load manifold-3d:', err)
})
```

To:

```typescript
.catch((err) => {
  console.error('[ManifoldWorker] Failed to load manifold-3d:', err)
  const msg: InitErrorMessage = {
    type: 'init-error',
    error: err instanceof Error ? err.message : 'Failed to load WASM module'
  }
  postMessage(msg)
})
```

**Step 3: Handle error in useManifold**

In `src/hooks/useManifold.ts`, update the `WorkerResponse` type (line 61):

```typescript
interface InitErrorMessage {
  type: 'init-error'
  error: string
}

type WorkerResponse = BuildResponse | ReadyMessage | InitErrorMessage
```

Then in the message handler (around line 128-135), add handling:

```typescript
if (data.type === 'ready') {
  this.workerReady = true
  resolve()
  return
}

if (data.type === 'init-error') {
  reject(new Error(data.error))
  return
}
```

**Step 4: Run all tests**

Run: `npm test -- --run`
Expected: All tests pass (this is a runtime fix, existing tests should still work)

**Step 5: Commit**

```bash
git add src/workers/manifold.worker.ts src/hooks/useManifold.ts
git commit -m "fix(worker): communicate WASM init failure to main thread"
```

---

## Task 5: Fix Hook hole_diameter Dynamic Max

**Files:**
- Modify: `src/generators/hook.ts:39-42`

**Context:** `dynamicMax` returns `thickness - 1`, but the hole is drilled through the width of the back plate, not the thickness. A hole diameter larger than the back plate width minus material margin would be invalid.

**Step 1: Analyze the geometry**

Looking at `hookBuilder.ts`:
- Back plate dimensions: `[thickness, hook_height, width]` - so width is in Z
- Hole is drilled through X axis (line 44: `.rotate(0, 90, 0)`)
- Hole position: centered on width (Z), positioned near top of hook_height (Y)
- Hole goes through `thickness` dimension

The current dynamicMax `thickness - 1` is actually correct for preventing the hole from being larger than the plate it goes through. But min wall should be 1.2mm not 1mm.

**Step 2: Fix to use proper wall thickness**

In `src/generators/hook.ts`, change line 42 from:

```typescript
return Math.max(0, thickness - 1)
```

To:

```typescript
// Leave at least 1.2mm material around hole (AGENTS.md minimum)
return Math.max(0, thickness - 1.2)
```

**Step 3: Run tests**

Run: `npm test -- --run src/generators/manifold/hookBuilder.test.ts`
Expected: PASS

**Step 4: Commit**

```bash
git add src/generators/hook.ts
git commit -m "fix(hook): use 1.2mm minimum wall around mounting hole"
```

---

## Summary

| Task | Bug | Severity | Status |
|------|-----|----------|--------|
| 1 | Spacer wall thickness | High | [ ] |
| 2 | Washer wall thickness | High | [ ] |
| 3 | Bracket rib_thickness | Critical | [ ] |
| 4 | Worker init failure | Critical | [ ] |
| 5 | Hook hole_diameter | High | [ ] |

**Total tasks: 5**
**Estimated time: 30-45 minutes**
